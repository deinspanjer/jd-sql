version: '3'

tasks:
  build-runner:
    desc: Build the Go jd-sql-spec-runner (host)
    dir: test-src
    cmds:
      - |
        echo "[jd-sql] Building Go jd-sql-spec-runner for $(go env GOOS)/$(go env GOARCH)"
        mkdir -p ../out/test/bin
        # Ensure Go modules are resolved for the runner
        go mod tidy
        go mod download
        # Build Go runner into the project output dir
        go build -o ../out/test/bin/jd-sql-spec-runner ./jd-sql-spec-runner

  build-upstream:
    desc: Build upstream Go spec test-runner for host arch (overrides any bundled binary)
    dir: external/jd/spec/test
    cmds:
      - |
        echo "[jd-sql] Building upstream jd/spec/test runner for $(go env GOOS)/$(go env GOARCH)"
        # Build into the project compiler output dir to avoid dirtying external/jd
        mkdir -p ../../../../out/test/bin
        # Ensure Go modules are available for the upstream runner
        go mod download
        go build -o ../../../../out/test/bin/jd-upstream-test-runner .

  test:
    desc: Run upstream jd specifications via jd-sql-spec-runner (Postgres)
    vars:
      CFG: '{{.CFG | default "test-src/testdata/jd-sql-spec-runner/configs/postgres-plpgsql.yaml"}}'
    cmds:
      - task: :pg:install-sql
      - task: build-runner
      - task: build-upstream
      - |
        set -euo pipefail
        echo "[jd-sql] Staging upstream spec tests under out/test..."
        # Prepare test workspace
        mkdir -p out/test
        rm -f out/test/test-results.json
        # Copy needed upstream test files
        cp -R external/jd/spec/test/cases out/test
        cp -R external/jd/spec/test/testdata out/test
        # Provide jd-sql runner config as jd-sql-spec.yaml in the workspace
        cp "{{.CFG}}" out/test/jd-sql-spec.yaml
        echo "[jd-sql] Running upstream CORE tests from out/test"
        # Run only the CORE compliance suite (50 core tests) to align with Java harness
        (cd out/test && ./bin/jd-upstream-test-runner -verbose -core-only ./bin/jd-sql-spec-runner -c jd-sql-spec.yaml)
